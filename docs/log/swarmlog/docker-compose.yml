version: "3.3"

networks:
  net:
    driver: overlay
    attachable: true

services:
  mongo:
    image: mongo:3
    networks:
      - net
    volumes:
      - /etc/localtime:/etc/localtime
      - /etc/timezone:/etc/timezone
      - /data/server/swarmlog/mongodb:/data/db:rw
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.labels.deploy.env == swarmlog
      resources:
        limits:
          memory: 1024M
        reservations:
          memory: 256M

  elasticsearch:
    image: elasticsearch:5.6.10
    networks:
      - net
    volumes:
      - /etc/localtime:/etc/localtime
      - /etc/timezone:/etc/timezone
      - /data/server/swarmlog/es:/usr/share/elasticsearch/data:rw
    environment:
      - http.host=0.0.0.0
      - transport.host=localhost
      - network.host=0.0.0.0
      # Disable X-Pack security: https://www.elastic.co/guide/en/elasticsearch/reference/5.6/security-settings.html#general-security-settings
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - bootstrap.memory_lock=true
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.labels.deploy.env == swarmlog
      resources:
        limits:
          memory: 1024M
        reservations:
          memory: 512M

  graylog:
    image: graylog/graylog:2.4.6-1
    ports:
      # Graylog web interface and REST API
      - "9000:9000"
      # Syslog
      - "514:514"
      - "514:514/udp"
      # GELF
      - "12201:12201"
      - "12201:12201/udp"
    networks:
      - net
    volumes:
      - /etc/localtime:/etc/localtime
      - /etc/timezone:/etc/timezone
      - /data/server/swarmlog/graylog:/usr/share/graylog/data/journal:rw
    environment:
      # CHANGE ME!
      - GRAYLOG_PASSWORD_SECRET=${GRAYLOG_PASSWORD_SECRET}
      # use `yourpassword` for exp:
      # $ echo -n yourpassword | sha256sum
      - GRAYLOG_ROOT_PASSWORD_SHA2=${GRAYLOG_ROOT_PASSWORD_SHA2}
      - GRAYLOG_WEB_ENDPOINT_URI=${GRAYLOG_WEB_ENDPOINT_URI}
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.labels.deploy.env == swarmlog
      resources:
        limits:
          memory: 1024M
        reservations:
          memory: 256M
